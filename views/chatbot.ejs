<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chatbot Gemini</title>
    <style>
        body, html { 
            margin: 0 !important; 
            padding: 0 !important; 
            height: 100%; 
            width: 100%; 
            overflow: hidden;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        .chat-container { 
            display: flex; 
            flex-direction: column; 
            height: 100vh; 
            width: 100vw; 
            background: white; 
        }

        .chat-header { 
            background-color: #007bff; 
            color: white; 
            padding: 12px 15px; 
            display: flex; 
            justify-content: space-between; 
            align-items: center; 
            font-weight: bold;
            box-sizing: border-box;
        }

        .btn-clear { 
            background: #dc3545; 
            color: white; 
            border: none; 
            padding: 4px 8px; 
            border-radius: 4px; 
            cursor: pointer; 
            font-size: 0.75em; 
        }

        .chat-box { 
            flex-grow: 1; 
            padding: 15px; 
            overflow-y: auto; 
            background-color: #e9ebee; 
            display: flex;
            flex-direction: column;
        }

        .message { margin-bottom: 12px; display: flex; }
        .message.user { justify-content: flex-end; }
        .message.model { justify-content: flex-start; }
        
        .message-bubble { 
            max-width: 85%; 
            padding: 8px 12px; 
            border-radius: 15px; 
            font-size: 0.9em;
            line-height: 1.4; 
            word-wrap: break-word; 
        }

        .message.user .message-bubble { background-color: #007bff; color: white; border-bottom-right-radius: 2px; }
        .message.model .message-bubble { background-color: #ffffff; color: #333; border: 1px solid #ddd; border-bottom-left-radius: 2px; }

        .chat-input-area { 
            padding: 10px; 
            border-top: 1px solid #ccc; 
            background: white; 
            display: flex; 
            align-items: center;
        }

        #chatInput { 
            flex-grow: 1; 
            padding: 8px 12px; 
            border: 1px solid #ccc; 
            border-radius: 20px; 
            margin-right: 8px; 
            outline: none;
        }

        #sendButton { 
            background-color: #28a745; 
            color: white; 
            border: none; 
            border-radius: 20px; 
            padding: 8px 15px; 
            cursor: pointer; 
            font-weight: bold;
        }

        .loading-dots { animation: blink 1.5s infinite; font-weight: bold; }
        @keyframes blink { 0%, 100% { opacity: 0.2; } 50% { opacity: 1; } }
    </style>
</head>
<body>
    <div class="chat-container">
        <div class="chat-header">
            <span>ðŸ¤– Asisten Toko Saiful</span>
            <button class="btn-clear" id="clearBtn">Hapus Chat</button>
        </div>
        
        <div class="chat-box" id="chatBox">
            <% history.forEach(msg => { %>
                <div class="message <%= msg.sender %>">
                    <div class="message-bubble"><%= msg.text %></div>
                </div>
            <% }); %>
        </div>

        <div class="chat-input-area">
            <input type="text" id="chatInput" placeholder="Tanya stok..." autocomplete="off">
            <button id="sendButton">Kirim</button>
        </div>
    </div>
    
    <script>
        const chatInput = document.getElementById('chatInput');
        const sendButton = document.getElementById('sendButton');
        const chatBox = document.getElementById('chatBox');
        const clearBtn = document.getElementById('clearBtn');

        chatBox.scrollTop = chatBox.scrollHeight;

        function appendMessage(text, sender, isLoading = false) {
            const div = document.createElement('div');
            div.classList.add('message', sender);
            const bubble = document.createElement('div');
            bubble.classList.add('message-bubble');
            if (isLoading) bubble.innerHTML = '<span class="loading-dots">...</span>';
            else bubble.textContent = text;
            div.appendChild(bubble);
            chatBox.appendChild(div);
            chatBox.scrollTop = chatBox.scrollHeight;
            return div;
        }

        async function sendMessage() {
            const msg = chatInput.value.trim();
            if (!msg) return;

            appendMessage(msg, 'user');
            chatInput.value = '';
            const loading = appendMessage("", 'model', true);

            try {
                const res = await fetch('/chat', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ message: msg })
                });
                const data = await res.json();
                chatBox.removeChild(loading);
                if (data.success) appendMessage(data.aiResponse, 'model');
            } catch (e) {
                chatBox.removeChild(loading);
                appendMessage("Gagal terhubung.", 'model');
            }
        }

        clearBtn.addEventListener('click', async () => {
            if (confirm('Hapus riwayat?')) {
                await fetch('/chat/clear', { method: 'POST' });
                chatBox.innerHTML = '';
            }
        });

        sendButton.addEventListener('click', sendMessage);
        chatInput.addEventListener('keypress', (e) => { if(e.key === 'Enter') sendMessage(); });
    </script>
</body>
</html>